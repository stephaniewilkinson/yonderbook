<%
  # Build summary lines for header
  summary_lines = [
    "There are #{@available_books.size} books available to check out right now.",
    "You can join the waiting list for #{@waitlist_books.size} books.",
    "#{@no_isbn_books.size} books could not be matched (missing ISBN)."
  ]

  header = {
    title: 'Finished!',
    summary_lines: summary_lines
  }

  # Shared search button SVG
  search_icon = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>'

  tabs = [
    {
      label: 'Available',
      title: 'Available Books',
      color: 'green',
      count: @available_books.size,
      empty_message: 'No books are currently available to check out.',
      books: @available_books.map do |title|
        {
          image: title.image,
          title: title.title,
          author: title.author,
          isbn: title.isbn,
          status_label: 'Available:',
          status_value: title.copies_owned == 999999 ? 'Unlimited' : "#{title.copies_available}/#{title.copies_owned}",
          button: {url: title.url, icon: '/svg/book.svg', label: 'Read', class: 'bg-secondary hover:bg-secondary/80'}
        }
      end
    },
    {
      label: 'Waitlist',
      title: 'Join the waitlist',
      color: 'yellow',
      count: @waitlist_books.size,
      empty_message: 'No books are currently on the waitlist.',
      books: @waitlist_books.map do |title|
        {
          image: title.image,
          title: title.title,
          author: title.author,
          isbn: title.isbn,
          status_label: 'Waitlist:',
          status_value: title.copies_owned == 999999 ? 'Unlimited' : "#{title.copies_available}/#{title.copies_owned}",
          button: {url: title.url, icon: '/svg/book.svg', label: 'Reserve', class: 'bg-secondary hover:bg-secondary/80'}
        }
      end
    },
    {
      label: 'Unavailable',
      title: 'Not available at this library',
      color: 'red',
      count: @unavailable_books.size,
      empty_message: 'All books from your shelf are available or on the waitlist!',
      action_button: {url: '/auth/library', icon: '/svg/refresh.svg', label: 'Try a different library'},
      books: @unavailable_books.map do |title|
        {
          image: title.image,
          title: title.title,
          author: title.author,
          isbn: title.isbn,
          opacity: true,
          status_label: 'Not owned by library',
          button: {
            url: "https://link.overdrive.com/?websiteID=#{@website_id}",
            icon_svg: search_icon,
            label: 'Search library',
            title: "Search your library for: #{title.title} by #{title.author}",
            class: 'bg-gray-600 hover:bg-gray-700'
          }
        }
      end
    },
    {
      label: 'Could Not Match',
      title: 'Could not match to library catalog',
      color: 'gray',
      count: @no_isbn_books.size,
      description: "These books are missing ISBN information in Goodreads, so we couldn't search for them in your library's catalog. Try searching for them manually on your library's website.",
      empty_message: 'All books on your shelf have ISBN numbers!',
      books: @no_isbn_books.map do |title|
        {
          image: title.image,
          title: title.title,
          author: title.author,
          opacity: true,
          status_label: 'Missing ISBN',
          button: {
            url: "https://link.overdrive.com/?websiteID=#{@website_id}",
            icon_svg: search_icon,
            label: 'Search library',
            title: "Search your library for: #{title.title} by #{title.author}",
            class: 'bg-gray-600 hover:bg-gray-700'
          }
        }
      end
    }
  ]
%>

<%= render('_tabbed_availability_results', header:, tabs:) %>
